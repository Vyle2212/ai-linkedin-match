import streamlit as st
from sentence_transformers import SentenceTransformer
from sklearn.metrics.pairwise import cosine_similarity
import fitz  # PyMuPDF

# Load model
@st.cache_resource
def load_model():
    return SentenceTransformer('all-MiniLM-L6-v2')

model = load_model()

st.set_page_config(page_title="CV & LinkedIn Matcher", layout="wide")
st.title("ğŸ¤– Match CV PDF & LinkedIn profile vá»›i 1 JD")

st.markdown("### ğŸ“ Nháº­p Job Description")
jd_text = st.text_area("Job Description", height=200)

st.markdown("---")
st.markdown("## ğŸ“‚ CÃ¡ch 1: Upload nhiá»u file PDF CV")
uploaded_files = st.file_uploader("Chá»n file PDF", type="pdf", accept_multiple_files=True)

st.markdown("## ğŸ§‘â€ğŸ’¼ CÃ¡ch 2: Paste ná»™i dung tá»« LinkedIn")
linkedin_profiles = st.text_area(
    "DÃ¡n nhiá»u LinkedIn profile, má»—i profile cÃ¡ch nhau bá»Ÿi dÃ²ng trá»‘ng",
    placeholder="VÃ­ dá»¥:\n\nNguyen Van A - Data Analyst with 5 years in FMCG...\n\nTran Thi B - SAP Consultant, experience in S/4HANA...\n",
    height=250
)

def extract_text_from_pdf(uploaded_file):
    text = ""
    with fitz.open(stream=uploaded_file.read(), filetype="pdf") as doc:
        for page in doc:
            text += page.get_text()
    return text

if st.button("ğŸ” Check Match"):
    if not jd_text.strip():
        st.warning("âš ï¸ Vui lÃ²ng nháº­p Job Description.")
    else:
        jd_vec = model.encode([jd_text])[0]
        results = []

        # Match cÃ¡c file PDF
        for file in uploaded_files:
            try:
                cv_text = extract_text_from_pdf(file)
                cv_vec = model.encode([cv_text])[0]
                score = cosine_similarity([cv_vec], [jd_vec])[0][0]
                results.append({"Nguá»“n": f"ğŸ“„ {file.name}", "Match %": round(score * 100, 2)})
            except:
                results.append({"Nguá»“n": f"ğŸ“„ {file.name}", "Match %": "âŒ Error Ä‘á»c PDF"})

        # Match cÃ¡c LinkedIn profile (tÃ¡ch theo 2 dÃ²ng trá»‘ng)
        profiles = [p.strip() for p in linkedin_profiles.strip().split("\n\n") if p.strip()]
        for i, profile_text in enumerate(profiles):
            try:
                prof_vec = model.encode([profile_text])[0]
                score = cosine_similarity([prof_vec], [jd_vec])[0][0]
                results.append({"Nguá»“n": f"ğŸ§‘ LinkedIn Profile #{i+1}", "Match %": round(score * 100, 2)})
            except:
                results.append({"Nguá»“n": f"ğŸ§‘ LinkedIn Profile #{i+1}", "Match %": "âŒ Error match"})

        st.markdown("### ğŸ“Š Káº¿t quáº£ so sÃ¡nh:")
        st.dataframe(results, use_container_width=True)
